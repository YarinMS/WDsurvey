%% detrending comparison


maso.plotRMS
hold on
MSU.plotRMS
%%

tms = maso.JD;
tms   = datetime(tms,'convertfrom','jd') -seconds(10);
Rjd = datetime(Results.JD,'convertfrom','jd') ;
indices = ismember(juliandate(Rjd), juliandate(tms))
%%
Res = struct();
Res.FIELDID  = Results.FIELDID(indices)
Res.JD= Results.JD(indices)
Res.FWHM= Results.FWHM(indices)
Res.LimMag= Results.LimMag(indices)
Res.Coord= Results.Coord(indices)
Res.AMtime= Results.AMtime(indices)
Res.AM= Results.AM(indices)

%%
Color = [ 1.4526
       1.2691
       1.1316
       1.2231
       1.4961
       0.8857
        1.276
       2.5758
      0.81013
        1.378
       2.3418
       1.6131
      0.91735
       2.5296
       0.9107
      0.81669
       1.3727
       1.6473
      0.78333
       2.2547
      0.75493
       0.7779
       1.2724
       1.0256
       1.0284
       1.0962
       1.2121
      0.88407
      0.78479
      0.79382
      0.86294
      0.96311
       1.5404
       1.6793
       1.8679
       1.0023
       1.2237
       1.1039
       1.9158
       1.0733
          NaN
       1.2097
       1.2375
      0.98002
      0.97222
      0.95265
      0.79643
       1.6233
       0.7871
       1.9984
        1.085
      0.99242
      0.84243
       1.2224
      0.83573
      0.81089
      0.85714
      0.82818
      0.76951
       1.0524
       1.8887
       1.9183
       1.1981
       2.5399
      0.87596
      0.83544
       1.2922
       2.0884
      0.93788
       1.2498
       0.7699
       1.3212
       1.5778
      0.65961
       1.5445
      0.72631
       1.9327
       2.1403
      0.96901
       1.1161
       2.1786
      0.79758
       1.5131
      0.83309
       1.6217
      0.81175
          NaN
       1.1982
      0.93414
       1.8224
      0.89135
       2.2418
       1.0491
       1.2135
      0.95708
      0.83915
       1.2922
       1.2947
       1.2575
       1.1091
       2.5741
       1.1107
       2.1273
       1.1417
       1.7459
        1.356
       1.0784
      0.92259
       1.9071
       2.4434
       1.5537
       1.4692
      0.96258
       1.9066
       1.0282
       1.1497
       1.4515
      0.78229
       1.0254
       1.4091
       1.3826
       1.7653
          NaN
       1.0067
      0.96251
       0.8059
       1.2208
       1.1668
       1.4773
      0.89298
       1.3541
       1.4043
       1.5134
      0.90784
      0.85108
      0.69988
       0.8337
      0.97555
      0.94037
       1.0831
       2.4532
       1.0709
      0.50973
          NaN
       1.0719
       1.1627
       2.1118
       1.9765
       1.7585
       2.3911
      0.95717
        2.455
      0.99029
          NaN
       1.3648
       0.8217
       1.7441
       1.0093
       2.5255
       1.4567
      0.86661
       1.7973
       1.5139
       1.1503
          NaN
      0.96902
       2.6978
          NaN
       2.2582
       1.4426
       1.2688
      0.94374
      0.97026
        1.146
       1.1377
      0.94684
        1.749
      0.98621
       1.2503
      0.86512
       1.0635
       1.2618
       1.2531
      0.88182
       2.5475
       1.5227
       1.5182
       1.9496
       1.0541
       1.0675
          NaN
       2.0989
       1.6052
       1.4352
       1.1754
       1.1182
        0.897
       2.3388
        1.482
      0.91666
        1.369
       2.0544
       1.2729
       1.0685
       1.1264
       1.2151
       1.0922
       1.2013
       1.0057
       2.5173
      0.78912
       1.0435
       1.1983
       1.2764
       2.3703
       1.3201
       2.6265
          NaN
     -0.13063
       1.6107
       2.6434
       1.3293
       1.6511
       2.7033
       2.6956
      0.79591
       2.2131
       1.6447
          NaN
       1.3163
       1.3545
      0.82047
       1.3043
       1.8046
      0.89128
       1.4935
       1.5623
       1.2701
       1.3236
      0.99784
       2.0019
      0.85217
      0.72888
       1.0746
       1.0421
       1.9322
       1.1618
        0.868
          NaN
       1.2243
       2.4214
      0.94188
       1.7692
      0.96723
       1.3204
      0.52321
       1.9919
       1.0866
      0.90809
       1.1361
       1.4958
      0.81307
       2.7305
      0.92547
       1.2243
          NaN
       1.5167
       1.0796
       1.2836
       1.6216
       1.0567
       1.7458
       2.0551
       1.2472
      0.87969
      0.75074
       1.9297
       1.9189
       1.4901
      0.89238
      0.95715
       1.1103
      0.96167
       1.0192
       1.1144
       1.2975
        1.062
      0.97193
       1.1627
       2.3887
          NaN
      0.88311
       2.2092
       1.1312
      0.83765
       1.1203
       1.5654
       1.2751
       1.5423
       1.1959
       2.6481
       2.0317
       1.1523
       1.7383
       1.6273
       1.1153
      0.65907
       1.6854
      0.83247
      0.94955
        1.263
      0.85343
      0.97677
          NaN
      0.86806
      0.85486
        1.247
       1.5821
       2.5829
       1.9101
      0.89879
       1.6468
       2.2172
      0.89915
       1.0115
       1.1099
       0.8824
      0.87313
       1.7794
       1.7957
       1.1527
       1.0757
       1.0958
       1.9084
          NaN
       1.0721
        1.226
       2.6203
       1.1429
       1.9384
        0.966
        1.612
       1.2272
       1.7563
        1.652
       1.5596
       2.5856
       2.1232
          NaN
       1.8226
       1.0963
       1.2332
       1.0986
      0.93883
        1.058
       1.5311
       1.2875
       2.8722
       1.6677
      0.91596
       1.1334
       1.4813
       2.1043
       1.1055
          NaN
      0.84634
       2.5512
       2.0881
       1.6968
       1.5047
          NaN
       1.0856
       2.7449
      0.96555
       3.1095
       1.4353
      0.81308
      0.87423
       1.4211
       1.1315
       2.2039
       1.3222
        1.021
       1.6289
       2.5807
       1.3182
       1.5454
       1.5073
      0.88221
       1.0974
       1.1525
       0.8372
       2.4072
      0.91672
       1.1066
       1.1807
          NaN
       1.5359
       2.0801
          NaN
          NaN
          NaN
       1.0749
       1.5348
      0.97593
      0.97171
       1.5199
       1.4392
      0.97347
        1.219
       1.1576
       2.3239
       1.5842
       1.8515
      0.92069
       1.4285
       1.9117
       1.1454
       1.3545
      0.76544
         1.14
       1.0188
        1.725
       1.3233
       1.1958
       1.1648
       1.0661
        0.903
          NaN
        2.817
      0.16141
          NaN
      0.96615
        2.132
        2.793
       2.0773
       1.9433
      0.78261
      0.91156
       1.1923
       1.9623
      0.83028
       1.6071
      0.77658
       1.5053
        1.191
        1.733
       1.0566
          NaN
       1.0738
      0.84031
       1.1577
       1.8902
       1.2325
          NaN
      0.94188
       1.9475
       1.5703
       2.1284
      0.95221
      0.96946
       2.8523
       1.3553
       2.3677
       1.4276
          NaN
       2.2833
          NaN
       1.4001
      0.78286
       1.4052
        1.225
       1.3052
       1.2465
      0.90386
       1.7807
       1.8898
       1.0504
      0.87968
       1.6972
       0.7882
       1.8838
       1.0004
      0.98088
       1.2782
       1.1771
        1.258
       1.9477
       1.5795
       1.7607
       1.9174
       1.0927
       1.9959
       1.5647
      0.84498
      0.97692
          NaN
       1.0705
       1.2595
       2.3361
       1.8779
       1.5837
      0.93087
       2.1096
          NaN
       1.7511
       1.2206
       2.4116
       2.7906
      0.79127
       1.8035
       1.0488
       1.1142
       1.0386
      0.91132
       2.1516
       1.4836
      0.81089
        1.227
       1.3048
       1.1304
       1.0835
        1.199
       1.1138
        0.838
      0.87023
       2.0014
       0.8706
      0.97502
       1.0571
       1.6483
       2.0449
      0.92146
        1.487
        1.467
       1.4634
          NaN
       0.8894
        2.047
       1.9574
       1.8134
       1.1285
       0.9565
          NaN
       1.0765
       2.1435
      0.99969
       1.1161
       1.1113
       1.0187
       1.1928
       2.2708
       1.2721
      0.84724
       1.0452
       1.9378
        1.977
       1.2333
       1.5449
      0.84522
       1.2441
       1.3532
       1.2923
       1.0275
       1.3617
      0.90371
        1.421
       1.3886
      0.91577
       2.1841
        1.131
      0.86557
      0.86455
      0.93625
       1.1254
       1.8319
       1.0193
       1.5892
       1.5344
       1.3415
      0.90925
          NaN
       1.1876
        1.408
       1.0547
       1.1443
       1.0025
      0.94911
      0.97293
       2.0698
       1.1582
        1.073
       1.7322
       2.1716
      0.79432
      0.89798
       1.8717
          NaN
        1.022
       1.3828
        1.045
       1.2408
      0.98614
      0.50296
      0.91453
          NaN
       1.1969
      0.96595
      0.44329
        1.566
       1.6498
       1.5584
       1.2419
       1.6933
        1.678
       2.2198
      0.91311
        1.006
         1.54
       2.2636
      0.95113
        3.363
       1.0781
       1.1914
       1.0983
       2.4401
        1.911
       0.7852
       1.9519
       1.5088
       1.7022
          NaN
       1.4532
       0.7757
       2.4703
      0.90597
       1.5741
       1.6209
      0.87034
       1.2489
       1.1052
      0.76866
       1.5454
      0.81393
       1.8139
       0.8971
       1.0104
      0.92257
       1.1001
       1.9548
       1.3846
       1.5032
       1.0005
      0.90023
       2.9684
       1.0907
       1.6286
       2.4368
       1.5309
       1.6509
       1.3575
      0.82156
       1.3029
       2.4499
      0.92422
       1.5982
       1.7996
      0.89612
        1.193
      0.92307
       1.2048
      0.84447
      0.91646
       1.0214
       1.6211
       1.8827
       1.3404
       1.2038
      0.87519
       1.9934
       1.7501
       1.5884
       1.0501
      0.86866
       1.1242
       2.0228
       1.2906
       1.4441
      0.68728
       2.0917
         1.14
      0.87335
      0.85445
       1.8771
       1.2987
       2.7606
      0.87275
      0.96401
       1.2196
       1.9028
        0.977
       2.4557
      0.96465
       1.0328
       1.1087
        1.854
       1.2825
       1.9114
       2.2106
       2.0613
        2.223
       1.1195
          NaN
       1.4181
      0.91402
      0.94392
       2.0266
         2.33
      0.78934
        1.295
       1.0617
       1.3571
       1.1612
       2.9344
       1.2585
       1.5415
      0.99375
          NaN
       2.3454
       1.5713
       1.5572
          NaN
       1.4331
       1.1847
       2.3108
      0.90223
       1.0225]
%%
 %[AirMass,t] = getAirmass(maso,'Results',Res)
 AirMass = Res.AM
 %%




%%
idx1 = maso.Data.SrcIdx;
LM   = MSU.Data.MAG_PSF(:,idx1);
Err  = MSU.Data.MAGERR_PSF(:,idx1);

[MMM,H,Par,m] = TrendCC(LM,Color,'JD',maso.JD,'Err',Err)


%%
figure();
idex = 5;
%plot(MMM(:,idex))
idx = maso.Data.SrcIdx(idex);
med = median(maso.Data.MAG_PSF(:,idx),'omitnan');
plot(MMM(:,idex)+med)
hold on
plot(maso.Data.MAG_PSF(:,idx))

%%
figure('Color','white')

p = maso.plotRMS("PlotSymbol",'.')
hold on
semilogy(p.XData,std(MMM,'omitnan'),'x')
hold on
MSU.plotRMS('PlotSymbol','o')
%%
[MMMM,H,Par,m] = TrendCC(MMM,Color,'JD',maso.JD,'Err',Err)
%%
figure('Color','white')

p = maso.plotRMS("PlotSymbol",'.')
hold on
semilogy(p.XData,std(MMMM,'omitnan'),'x')
hold on
MSU.plotRMS('PlotSymbol','o')


%%
%LM   = maso.Data.MAG_PSF;
%
% Err  = maso.Data.MAGERR_PSF;

[MMM,H,Par,m] = TrendCCAM(MMM,Color,'JD',maso.JD,'Err',Err,'AM',AirMass)

figure('Color','white')

p = maso.plotRMS("PlotSymbol",'o')
hold on
semilogy(p.XData,std(MMM,'omitnan'),'.')


%% Get Data for PDT

for I = 1:numel(maso.Data.X1(1,idx1))
    if ~isnan(maso.Data.X1(1,idx1(I)))
fprintf('[%.3f,%.3f],\n',maso.Data.X1(1,idx1(I)),maso.Data.Y1(1,(idx1(I))) )
    end

end

%%
store =[];
for I = 1:numel(maso.Data.X1(1,idx1))
    if ~isnan(median(maso.Data.MAG_PSF(:,I)))
        store = [store ; I];
    fprintf('[')

    for i = 1 :numel(maso.Data.MAG_PSF(:,I))

      fprintf('%.7f ,',maso.Data.MAG_PSF(i,I)' )


    end

fprintf('],\n')
    end
end




%%

%% Get Data for PDT
idx1 = maso.Data.SrcIdx;
for I = 1:numel(store)

fprintf('[%.3f,%.3f],\n',maso.Data.X1(1,idx1(store(I))),maso.Data.Y1(1,(idx1(store(I)))) )


 
end


 %%
 %[DD,reff,FR,Mod] =  lsqRelPhotByEranV4(model,'Niter', 2,'obj',e,'wdt',Idx,)
RES =  lsqRelPhotByEranGOODVER(MSU,'Niter',2,'StarProp',{Color})%,'ImageProp',{AirMass})

r = reshape(RES.Resid,[size(model.Data.MAG_PSF)]);
std_r = std(r,'omitnan')

[rms1,meanmag0]  = CalcRMS(Mag,r,e,Idx,'Marker','xk','Predicted',false)